<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Supervisor - 应用</title>
    <meta charset="UTF-8"/>
    <link href="stylesheets/stat.css" rel="stylesheet" type="text/css" />
    <link href="http://keleyi.com/keleyi/phtml/jqplug/index/jquery.alerts.css" rel="stylesheet" type="text/css" />
    <script src="http://keleyi.com/keleyi/pmedia/jquery-1.10.1.min.js" type="text/javascript"></script>
    <script src="http://keleyi.com/keleyi/pmedia/jquery/ui/1.10.3/js/jquery-ui-1.10.3.min.js" type="text/javascript"></script>
    <script src="http://keleyi.com/keleyi/phtml/jqplug/index/jquery.alerts.js" type="text/javascript"></script>
    <script src="./func.js" type="text/javascript"></script>
    <script>
        var _desc = ['警告', '停止', '正常', '错误'];
        
        $(document).ready(function () {
            refresh_list();
            setInterval(function() {
                refresh_list();
                refresh_rows();
            }, 5000);
        });
        
        function stop_app(name) {
            jConfirm('是否要停止应用 ' + name + ' ？', '确认', function(r) {
                if (r) {
                    _stop_app(name, function() {
                        jAlert('已经发出停止指令', '提示');
                    });
                }
            });
        }

        function start_app(name) {
            _start_app(name, function(msg, stat) {
                jAlert('已经发出启动指令', '提示');
            });
        }

        function scale_app(name) {
            _get_app(name, function(app) {
                jPrompt('输入应用 ' + name + ' 的规模：', app.scale, '输入', function (n) {
                    if (n) {
                        _put_scale(name, n, function(msg, stat) {
                            jAlert('更新成功', '提示');
                        });
                    }
                });
            });
        }
        
        function restart_all() {
            jConfirm('已经停止的应用仍然保持停止状态，需要继续吗？', '确认', function(r) {
                if (r) {
                    _get_proc_list(function(ps, status) {
                        $.each(ps, function(i, p) {
                            _kill_proc(p, function(ret, status) {});
                        });
                        jAlert('已经发出重启指令', '提示');
                    });
                }
            });
        }
        
        function stop_all() {
            jConfirm('停止所有应用，需要继续吗？', '确认', function(r) {
                if (r) {
                    var keys = get_table_keys();
                    $.each(keys, function(i, app_name) {
                        _stop_app(app_name, function(ret, status) {});
                    });
                    jAlert('已经发出停止指令', '提示');
                }
            });
        }
        
        function refresh_rows() {
            var keys = get_table_keys();
            $.each(keys, function(i, app_name) {
                refresh_row(app_name);
            });
        }
        
        function refresh_row(app_name) {
            _get_app(app_name, function(app_data, status) {
                var scale = app_data.scale;
                var start = app_data.start;
                _get_app_proc_list(app_name, function(proc_list, status) {
                    var proc_count = proc_list.length;
                    update_row(app_name, start, scale, proc_count);
                });
            });
        }
        
        function refresh_list() {
            _get_app_list(function(app_names, status) {
                //remove deleted app
                var keys = get_table_keys();
                $.each(keys, function(i, key) {
                    if ($.inArray(key, app_names) < 0) {
                        remove_row(key);
                    }
                });
                
                //add new app
                $.each(app_names, function(i, app_name) {
                    if ($.inArray(app_name, keys) < 0) {
                        add_row(app_name);
                        refresh_row(app_name);
                    }
                });
            });
        }
        
        function get_table_keys() {
            var keys = new Array();
            var key = '';
            $("#statustable tr td:nth-child(1)").each(function () {
                key = $(this).text();
                if (key) {
                    keys.push(key);
                }
            });
            //alert(keys);
            return keys;
        }
        
        function update_row(app_name, start, scale, ps) {
            var status = 0;
            var status_desc;
            if (start && scale > 0) {
                if (ps >= scale) {
                    status = 2;
                } else if (scale > ps && ps > 0) {
                    status = 0;
                } else if (ps == 0) {
                    status = 3;
                }
            } else {
                status = 1;
            }
            var status_desc = _desc[status];
            
            //status image
            $('#status_text_' + app_name).attr('class', 'status' + status);
            $('#status_text_' + app_name).text(status_desc);
            
            //process count
            $('#count_' + app_name).text(start ? ps : '停止');
            
            //scale
            $('#scale_' + app_name).text(scale);

            //action            
            if (start) {
                $('#action_stop_' + app_name).show();
                $('#action_start_' + app_name).css('display', 'none');
            } else {
                $('#action_stop_' + app_name).css('display', 'none');
                $('#action_start_' + app_name).show();
            }
        }
        
        function remove_row(name) {
            //alert('remove row: ' + name);
            var keys = get_table_keys();
            var pos = $.inArray(name, keys);
            if (pos >= 0) {
                $("#statustable tr:gt(0):eq(" + pos + ")").remove();
            }
        }
        
        function add_row(name) {
            var row = '<tr id="tr_' + name + '" class="">';
            row += '<td class="hidden">' + name + '</td>';
            row += '<td class="status"><span id="status_text_' + name + '" class=""></span></td>';
            row += '<td><span id="count_' + name + '"></span></td>';
            row += '<td><span id="scale_' + name + '"></span></td>';
            row += '<td><a href="proc.html?app=' + name + '">' + name + '</a></td>';
            row += '<td class="action">';
            row += '<ul>';
            row += '<li">';
            row += '<a href="app.html?name=' + name + '" id="action_edit">编辑</a> ';
            row += '</li>';
            row += '<li">';
            row += '<a href="#" onclick="scale_app(\'' + name + '\')" id="action_scale">调整规模</a> ';
            row += '</li>';
            row += '<li">';
            row += '<a href="#" onclick="start_app(\'' + name + '\')" id="action_start_' + name + '" style="display:none">启动</a> ';
            row += '</li>';
            row += '<li">';
            row += '<a href="#" onclick="stop_app(\'' + name + '\')" id="action_stop_' + name + '" style="display:none">停止</a> ';
            row += '</li>';
            row += '</ul>';
            row += '</td>';
            row += '</tr>';
            $("#statustable tr:last").after(row);
        }
    </script>
</head>
<body>
<div id="wrapper">

    <div id="header">
        <a href="/"><img src="images/stat.gif" alt="Status" /></a>
    </div>

    <div id="content">
        <div class="hidden" id="statusmessage">&nbsp;</div>

        <ul id="buttons" class="clr">
            <li id="restart_all"><a onclick="restart_all()" href="#">&nbsp;</a></li>
            <li id="stop_all"><a onclick="stop_all()" href="#">&nbsp;</a></li>
        </ul>

        <table cellspacing="0" id="statustable">
            <tr>
              <th class="hidden"></th>
              <th class="state">状态</th>
              <th class="count">进程数</th>
              <th class="scale">计划规模</th>
              <th class="name">名称</th>
              <th class="action">操作</th>
            </tr>
        </table>
    </div>

    <div class="push">
    </div>
</div>

<div id="footer" class="clr">
    <div class="left">
        <a href="/">Supervisor</a> <span id="supervisor_version">#</span>
    </div>
    <div class="right">
        &amp;copy; 2006-<span id="copyright_date">#</span> <strong>iFlytek</strong>
    </div>
</div>
</body>
</html>
