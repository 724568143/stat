<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>Supervisor - 进程列表</title>
    <meta charset="UTF-8"/>
    <link href="stylesheets/stat.css" rel="stylesheet" type="text/css" />
    <link href="stylesheets/jquery.alerts.css" rel="stylesheet" type="text/css" />
    <script src="js/jquery-1.10.1.min.js" type="text/javascript"></script>
    <script src="js/jquery-ui-1.10.3.min.js" type="text/javascript"></script>
    <script src="js/jquery.alerts.js" type="text/javascript"></script>
    <script src="js/common.js" type="text/javascript"></script>
    <script>
        $(document).ready(function () {
            var app = _get_param('app').app.replace('#', '');
            
            _get_node(function(node, status) {
                refresh_list(app, node);
                setInterval(function() {
                    refresh_list(app, node);
                }, 5000);
            });
        });
        
        function kill_all() {
            jConfirm('重新启动所有进程，需要继续吗？', '确认', function(r) {
                if (r) {
                    var keys = get_table_keys();
                    $.each(keys, function(i, key) {
                        _kill_proc(key, function(msg, status) {});
                    });
                    jAlert('已经发出重启指令', '提示');
                }
            });
        }
        
        function kill(pid) {
            jConfirm('停止进程，需要继续吗？', '确认', function(r) {
                if (r) {
                    _kill_proc(pid, function(msg, status) {});
                    jAlert('已经发出停止指令', '提示');
                }
            });
        }

        function refresh_list(app, node) {
            _get_app_proc_list(app, function(ps, status) {
                //remove deleted row
                var keys = get_table_keys();
                $.each(keys, function(i, key) {
                    if ($.inArray(key, ps) < 0) {
                        remove_row(key);
                    }
                });
                
                //add new row
                $.each(ps, function(i, pid) {
                    if ($.inArray(pid, keys) < 0) {
                        add_row(pid);
                        refresh_row(pid, node);
                    }
                });
            });
        }
        
        function get_table_keys() {
            var keys = new Array();
            var key = '';
            $("#statustable tr td:nth-child(1)").each(function () {
                key = $(this).text();
                if (key) {
                    keys.push(parseInt(key));
                }
            });
            return keys;
        }
        
        function refresh_row(pid, node) {
            _get_proc(pid, function(p, status) {
                update_row(p, node);
            });
        }
        
        function update_row(p, node) {
            var text = new Array();
            $.each(p.ports, function(i, port) {
                text.push('<a href="http://' + node.hostname + ':' + port + '" target="_blank">' + port + '</a>');
            });
            
            $('#ppid_' + p.pid).text(p.ppid);
            $('#stime_' + p.pid).text(p.startTime);
            $('#cmd_' + p.pid).text(p.cmd);
            $('#port_' + p.pid).html(text.join(', '));
        }
        
        function add_row(pid) {
            var row = '<tr id="tr_' + pid + '" class="">';
            row += '<td class="hidden">' + pid + '</td>';
            row += '<td><span id="pid_' + pid + '">' + pid + '</span></td>';
            row += '<td><span id="ppid_' + pid + '"></span></td>';
            row += '<td><span id="stime_' + pid + '"></span></td>';
            row += '<td><span id="cmd_' + pid + '"></span></td>';
            row += '<td><span id="port_' + pid + '"></span></td>';
            row += '<td class="action">';
            row += '<ul>';
            row += '<li">';
            row += '<a href="tail.html?pid=' + pid + '&out=stdout" id="action_stdout" target="_blank">stdout</a> ';
            row += '</li>';
            row += '<li">';
            row += '<a href="tail.html?pid=' + pid + '&out=stderr" id="action_stderr" target="_blank">stderr</a> ';
            row += '</li>';
            row += '<li">';
            row += '<a href="#" onclick="kill(' + pid + ')" id="action_kill">kill</a> ';
            row += '</li>';
            row += '</ul>';
            row += '</td>';
            row += '</tr>';
            $("#statustable tr:last").after(row);
        }
        
        function remove_row(name) {
            var keys = get_table_keys();
            var pos = $.inArray(name, keys);
            if (pos >= 0) {
                $("#statustable tr:gt(0):eq(" + pos + ")").remove();
            }
        }
    </script>
</head>
<body>
<div id="wrapper">

    <div id="header">
        <a href="/"><img src="images/stat.gif" alt="Status" /></a>
        <p id="nodestatus">
            主机：<strong><span id="hostname"></span></strong>（<span id="address"></span>）- 
            磁盘：<span id="diskspace"></span> GB - 
            内存：<span id="memory"></span> GB
        </p>
    </div>

    <div id="content">
        <div class="hidden" id="statusmessage">&nbsp;</div>
        <ul id="buttons" class="clr">
            <li id="restart_all"><a onclick="kill_all()" href="#">&nbsp;</a></li>
        </ul>
        <table cellspacing="0" id="statustable">
            <tr>
                <th class="hidden"></th>
                <th class="pid">PID</th>
                <th class="ppid">PPID</th>
                <th class="stime">开始时间</th>
                <th class="cmd">命令</th>
                <th class="port">端口</th>
                <th class="action">操作</th>
            </tr>
        </table>
    </div>

    <div class="push">
    </div>
</div>

<div id="footer" class="clr">
    <div class="left">
        <a href="/">Supervisor</a> <span id="supervisor_version">#</span>
    </div>
    <div class="right">
        &amp;copy; 2006-<span id="copyright_date">#</span> <strong>iFlytek</strong>
    </div>
</div>
</body>
</html>
